#include <stdio.h>
#include <string.h>

#define TEST(input, output) \
  do { \
    if (test(input, output)) { \
      printf("Error at %s\n", #input); \
      return -1; \
    } \
  } while(0)

//void Initialize_Fast_IDCT(void);
//void Fast_IDCT(short *block);
void Top_Fast_IDCT(long long ibl[8], long long ibh[8], long long obl[8], long long obh[8]);

int test(const short *input, const short *output) {
  short block[64];

  //memcpy(block, input, sizeof(block));
  //Fast_IDCT(block);
  int i, j;
  long long ibl[8], ibh[8];
  for (i = 0; i < 8; i++) {
    ibl[i] = ibh[i] = 0;
    for (j = 0; j < 4; j++) {
      ibl[i] |= (long long)(unsigned short)input[i * 8 + j] << (16 * j);
      ibh[i] |= (long long)(unsigned short)input[i * 8 + j + 4] << (16 * j);
    }
  }
  long long obl[8], obh[8];
  Top_Fast_IDCT(ibl, ibh, obl, obh);
  for (i = 0; i < 8; i++) {
    for (j = 0; j < 4; j++) {
      block[i * 8 + j] = obl[i] >> (16 * j);
      block[i * 8 + j + 4] = obh[i] >> (16 * j);
    }
  }
  return memcmp(block, output, sizeof(block));
}

int main() {
//  Initialize_Fast_IDCT();

  short inputx[] = {
    0, -1, -2, -3, -4, -5, -6, -7,
    -8, -9, -10, -11, -12, -13, -14, -15,
    -16, -17, -18, -19, -20, -21, -22, -23,
    -24, -25, -26, -27, -28, -29, -30, -31,
    -32, -33, -34, -35, -36, -37, -38, -39,
    -40, -41, -42, -43, -44, -45, -46, -47,
    -48, -49, -50, -51, -52, -53, -54, -55,
    -56, -57, -58, -59, -60, -61, -62, -63
  };

  short outputx[] = {
    -173, 63, -42, 19, -22, 5, -12, -4,
    176, -52, 39, -15, 21, -3, 12, 5,
    -71, 23, -16, 7, -9, 1, -5, -2,
    60, -17, 13, -5, 7, -1, 4, 2,
    -33, 11, -8, 3, -4, 1, -2, -1,
    26, -7, 6, -2, 3, 0, 2, 1,
    -11, 4, -3, 1, -1, 0, -1, 0,
    6, -1, 1, 0, 1, 0, 0, 0
  };

  TEST(inputx, outputx);

  short input0[] = {
     23,  -1,  -2,   0,   0,   0,   0,   0,
      0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,   0,   0,   0,   0,   0
  };

  short output0[] = {
      2,   3,   3,   3,   3,   3,   3,   3,
      2,   3,   3,   3,   3,   3,   3,   3,
      2,   3,   3,   3,   3,   3,   3,   3,
      2,   3,   3,   3,   3,   3,   3,   3,
      2,   3,   3,   3,   3,   3,   3,   3,
      2,   3,   3,   3,   3,   3,   3,   3,
      2,   3,   3,   3,   3,   3,   3,   3,
      2,   3,   3,   3,   3,   3,   3,   3
  };

  TEST(input0, output0);

  short input1[] = {
     13,  -7,   0,   0,   0,   0,   0,   0,
      0,   2,   0,   0,   0,   0,   0,   0,
      0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,   0,   0,   0,   0,   0
  };

  short output1[] = {
      1,   1,   1,   1,   2,   2,   2,   2,
      1,   1,   1,   1,   2,   2,   2,   2,
      1,   1,   1,   1,   2,   2,   2,   3,
      1,   1,   1,   1,   2,   2,   3,   3,
      0,   1,   1,   1,   2,   2,   3,   3,
      0,   0,   1,   1,   2,   2,   3,   3,
      0,   0,   1,   1,   2,   3,   3,   3,
      0,   0,   1,   1,   2,   3,   3,   3,
  };

  TEST(input1, output1);

  short input2[] = {
   -166,  -7,  -4,  -4,   0,   0,   0,   0,
     -2,   0,   0,   0,   0,   0,   0,   0,
     -2,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,   0,   0,   0,   0,   0
  };

  short output2[] = {
    -24, -23, -21, -21, -21, -21, -21, -20,
    -24, -22, -21, -20, -21, -21, -21, -20,
    -23, -22, -21, -20, -20, -21, -20, -20,
    -23, -22, -20, -20, -20, -20, -20, -19,
    -23, -22, -20, -20, -20, -20, -20, -19,
    -23, -22, -20, -20, -20, -20, -20, -19,
    -23, -22, -20, -20, -20, -20, -20, -19,
    -23, -22, -20, -20, -20, -20, -20, -20
  };

  TEST(input2, output2);

  short input3[] = {
   -240,   8, -11,  47,  26,  -6,   0,   5,
     28,  -6,  85,  44,  -4, -25,   5,  16,
     21,   8,  32, -16, -24,   0,  30,  12,
     -2,  18,   0,  -2,   0,   7,   0, -15,
      7,   4,  15, -24,   0,   9,   8,  -6,
      4,   9,   0,  -5,  -6,   0,   0,   0,
     -4,   0,  -6,   0,   0,  10, -10,  -8,
      6,   0,   0,   0,   0,   0,   0,  -8
  };

  short output3[] = {
     21, -10, -26, -61, -43, -17, -22,  -8,
      5, -28, -47, -73, -11, -14, -24, -17,
    -14, -31, -61, -45,  -5, -18, -22, -34,
    -23, -36, -49, -32, -12, -33, -33, -35,
    -30, -39, -53,  -8, -19, -31, -43, -42,
    -41, -43, -50,  -4, -15, -33, -44, -66,
    -40, -38, -21, -14, -17, -26, -46, -52,
    -44, -47,  -9, -12, -30, -33, -38, -37
  };

  TEST(input3, output3);

  printf("All tests passed\n");
  return 0;
}
